name: Netlify Preview Link

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  comment:
    runs-on: ubuntu-latest
    env:
      NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
      NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
      PR_NUMBER: ${{ github.event.pull_request.number }}
      REPO: ${{ github.repository }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Post Netlify deploy preview link
        run: |
          python - <<'PY'
          import json
          import os
          import urllib.request

          token = os.environ.get("NETLIFY_AUTH_TOKEN")
          site_id = os.environ.get("NETLIFY_SITE_ID")
          pr_number = os.environ.get("PR_NUMBER")
          repo = os.environ.get("REPO")
          gh_token = os.environ.get("GITHUB_TOKEN")

          if not token or not site_id:
            raise SystemExit("Missing NETLIFY_AUTH_TOKEN or NETLIFY_SITE_ID.")

          # Fetch deploy previews for this PR.
          url = f"https://api.netlify.com/api/v1/sites/{site_id}/deploys?per_page=10"
          req = urllib.request.Request(url, headers={"Authorization": f"Bearer {token}"})
          with urllib.request.urlopen(req) as resp:
            deploys = json.loads(resp.read().decode("utf-8"))

          preview = None
          for deploy in deploys:
            if str(deploy.get("review_id")) == str(pr_number) and deploy.get("context") == "deploy-preview":
              preview = deploy
              break

          if not preview:
            raise SystemExit("No deploy preview found yet.")

          preview_url = preview.get("deploy_ssl_url") or preview.get("ssl_url") or preview.get("url")
          if not preview_url:
            raise SystemExit("Deploy preview URL missing.")

          marker = "<!-- netlify-preview -->"
          body = f"{marker}\nNetlify Deploy Preview: {preview_url}"

          # Look for existing comment by this workflow.
          comments_url = f"https://api.github.com/repos/{repo}/issues/{pr_number}/comments"
          gh_headers = {
            "Authorization": f"Bearer {gh_token}",
            "Accept": "application/vnd.github+json",
            "X-GitHub-Api-Version": "2022-11-28",
          }
          req = urllib.request.Request(comments_url, headers=gh_headers)
          with urllib.request.urlopen(req) as resp:
            comments = json.loads(resp.read().decode("utf-8"))

          existing = None
          for comment in comments:
            if marker in comment.get("body", ""):
              existing = comment
              break

          if existing:
            update_url = f"https://api.github.com/repos/{repo}/issues/comments/{existing['id']}"
            req = urllib.request.Request(
              update_url,
              data=json.dumps({"body": body}).encode("utf-8"),
              headers=gh_headers,
              method="PATCH",
            )
            with urllib.request.urlopen(req) as resp:
              resp.read()
          else:
            req = urllib.request.Request(
              comments_url,
              data=json.dumps({"body": body}).encode("utf-8"),
              headers=gh_headers,
              method="POST",
            )
            with urllib.request.urlopen(req) as resp:
              resp.read()
          PY
